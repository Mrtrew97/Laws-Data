<script>
    let sheetData = [];

    // Fetch data from the Google Sheets script
    fetch("https://script.google.com/macros/s/AKfycbxXSyJJ19BpksulDCgg0HlGOKkzoJsdWWMmovQMjMXLImSIM-IQ7DOXMPbbJmn3VI9d6Q/exec")
        .then(response => response.json())
        .then(data => {
            sheetData = data;

            // Populate the custom dropdown with names from column E (assuming the header for column E is "Name")
            const dropdown = document.getElementById("name-dropdown");

            sheetData.forEach(item => {
                const name = item["Name"]; // Adjust if the header for column E is different
                const listItem = document.createElement("li");
                listItem.textContent = name;
                listItem.addEventListener("click", function() {
                    document.getElementById("search").value = name;
                    displayData(item);
                    document.getElementById("name-dropdown-container").style.display = "none"; // Hide dropdown after selection
                });
                dropdown.appendChild(listItem);
            });

            // Add search functionality for filtering names
            document.getElementById("search").addEventListener("input", function () {
                const searchTerm = this.value.toLowerCase();
                const filteredNames = sheetData
                    .filter(item => item["Name"].toLowerCase().includes(searchTerm))
                    .map(item => item["Name"]);

                // Clear previous options in the dropdown
                dropdown.innerHTML = "";

                // Add filtered names to the dropdown
                filteredNames.forEach(name => {
                    const listItem = document.createElement("li");
                    listItem.textContent = name;
                    listItem.addEventListener("click", function() {
                        document.getElementById("search").value = name;
                        const person = sheetData.find(item => item["Name"] === name);
                        displayData(person);
                        document.getElementById("name-dropdown-container").style.display = "none"; // Hide dropdown after selection
                    });
                    dropdown.appendChild(listItem);
                });

                // Show or hide dropdown depending on input
                document.getElementById("name-dropdown-container").style.display = searchTerm ? "block" : "none";
            });
        })
        .catch(error => console.error("Error fetching data:", error));

    // Function to display data for the selected person
    function displayData(person) {
        console.log(person); // Debugging: log the selected person to ensure correct data is passed

        // Check if data exists for Merit Percentage
        const totalMerits = sheetData.reduce((sum, row) => sum + parseFloat(row["Merits Gained"] || 0), 0);
        const playerMerits = parseFloat(person["Merits Gained"] || 0);

        if (totalMerits === 0 || isNaN(totalMerits)) {
            document.getElementById("merit-percentage").textContent = "0%"; // Default to 0% if no merits are found
        } else {
            document.getElementById("merit-percentage").textContent = ((playerMerits / totalMerits) * 100).toFixed(2) + "%";
        }

        // Populate each data box with the corresponding value, with checks for missing data
        document.getElementById("average-ap").textContent = person["Average AP"] || "N/A";
        document.getElementById("ap").textContent = person["AP"] || "N/A";
        document.getElementById("ap-gain").textContent = person["AP Gain"] || "N/A";
        document.getElementById("rank").textContent = person["Rank"] || "N/A";
        document.getElementById("power-change").textContent = person["Power Change"] || "N/A";
        document.getElementById("average-ap-gain").textContent = person["Average AP Gain"] || "N/A";
        document.getElementById("merits-gained-detail").textContent = person["Merits Gained"] || "N/A";
        document.getElementById("kill-change").textContent = person["Kill Change"] || "N/A";
        document.getElementById("merits-gained").textContent = person["Merits Gained Percentage"] || "N/A";
        document.getElementById("heal-change").textContent = person["Heal Change"] || "N/A";
        document.getElementById("death-change").textContent = person["Death Change"] || "N/A";
        document.getElementById("weekly-donations").textContent = person["Weekly Donations"] || "N/A";
        document.getElementById("weekly-build").textContent = person["Weekly Build"] || "N/A";
    }
</script>