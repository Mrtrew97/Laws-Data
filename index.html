<script>
let sheetData = [];

fetch("https://script.google.com/macros/s/AKfycbzfWV3OcGYEC55ZLSb_bKwg7wcxZPgBwjdeZ4pACUnkZrLiFAQq7UQxTnRRD1Bbt-VY/exec")
    .then(response => response.json())
    .then(data => {
        sheetData = data;
        populateDropdown(sheetData);
    })
    .catch(error => console.error("Error fetching data:", error));

function populateDropdown(data) {
    const searchInput = document.getElementById("search");

    searchInput.addEventListener("input", function () {
        const inputValue = searchInput.value.toLowerCase();
        const matchingNames = data
            .map(person => person["Name"])
            .filter(name => name.toLowerCase().includes(inputValue));

        showDropdown(matchingNames);
    });

    searchInput.addEventListener("change", function () {
        const selectedPerson = data.find(person => person["Name"] === searchInput.value);
        if (selectedPerson) {
            displayData(selectedPerson);
        }
    });
}

function showDropdown(names) {
    let dropdown = document.getElementById("dropdown");
    if (!dropdown) {
        dropdown = document.createElement("div");
        dropdown.id = "dropdown";
        dropdown.style.position = "absolute";
        dropdown.style.background = "#b4b4b4";
        dropdown.style.border = "2px solid black";
        dropdown.style.width = "300px";
        dropdown.style.zIndex = "1000";
        document.querySelector(".search-container").appendChild(dropdown);
    }
    dropdown.innerHTML = "";

    names.forEach(name => {
        const item = document.createElement("div");
        item.textContent = name;
        item.style.padding = "5px";
        item.style.cursor = "pointer";
        item.addEventListener("click", function () {
            document.getElementById("search").value = name;
            dropdown.innerHTML = "";
            const selectedPerson = sheetData.find(person => person["Name"] === name);
            displayData(selectedPerson);
        });
        dropdown.appendChild(item);
    });
}

function displayData(person) {
    if (!person) return;

    document.getElementById("ap").textContent = person["AP"] || "N/A";
    document.getElementById("ap-gain").textContent = person["AP Gain"] || "N/A";
    document.getElementById("rank").textContent = person["Rank"] || "N/A";
    document.getElementById("power-change").textContent = person["Power Change"] || "N/A";
    document.getElementById("merits-gained-detail").textContent = person["Merits Gained"] || "N/A";
    document.getElementById("kill-change").textContent = person["Kill Change"] || "N/A";
    document.getElementById("heal-change").textContent = person["Heal Change"] || "N/A";
    document.getElementById("death-change").textContent = person["Death Change"] || "N/A";
    document.getElementById("weekly-donations").textContent = person["Weekly Donations"] || "N/A";
    document.getElementById("weekly-build").textContent = person["Weekly Build"] || "N/A";

    const totalMerits = sheetData.reduce((sum, row) => sum + parseFloat(row["Merits Gained"] || 0), 0);
    const playerMerits = parseFloat(person["Merits Gained"] || 0);
    document.getElementById("merit-percentage").textContent = totalMerits ? ((playerMerits / totalMerits) * 100).toFixed(2) + "%" : "0%";
}
</script>